<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta
      name="description"
      content="Aktuelle Clubabende der Ohmoor Squeezers e.V. in Hamburg mit Datum, Uhrzeit, Ort und Caller."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <title>Ohmoor Squeezers e.V. - Clubabende</title>
  </head>
  <body>
    {{ include: nav.html }}
    <main class="container page">
      <h1>Ohmoor Squeezers e.V. - Clubabende</h1>
      <p class="muted">Alle Termine sind in lokaler Zeit (CET/CEST).</p>
      <p id="schedule-status" class="muted">Termine werden geladen...</p>
      <div id="schedule-content"></div>
    </main>
    <script>
      (function () {
        var TZ = "Europe/Berlin";
        var MONTHS_DE = [
          "Jan.",
          "Feb.",
          "Mrz.",
          "Apr.",
          "Mai",
          "Jun.",
          "Jul.",
          "Aug.",
          "Sep.",
          "Okt.",
          "Nov.",
          "Dez.",
        ];
        var datePartsFormatter = new Intl.DateTimeFormat("de-DE", {
          timeZone: TZ,
          day: "numeric",
          month: "numeric",
          year: "numeric",
        });
        var timeFormatter = new Intl.DateTimeFormat("de-DE", {
          timeZone: TZ,
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        });
        var statusEl = document.getElementById("schedule-status");
        var contentEl = document.getElementById("schedule-content");

        function escapeHtml(value) {
          return String(value || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        function toUtcDate(dateValue, timeValue) {
          var dt = new Date(dateValue + "T" + timeValue + ":00Z");
          if (Number.isNaN(dt.getTime())) {
            return null;
          }
          return dt;
        }

        function formatDateDe(date) {
          var parts = datePartsFormatter.formatToParts(date);
          var day = "1";
          var month = "1";
          var year = "1970";
          var i = 0;

          for (i = 0; i < parts.length; i += 1) {
            if (parts[i].type === "day") {
              day = parts[i].value;
            } else if (parts[i].type === "month") {
              month = parts[i].value;
            } else if (parts[i].type === "year") {
              year = parts[i].value;
            }
          }

          return day + ". " + MONTHS_DE[Number(month) - 1] + " " + year;
        }

        function formatTime(date) {
          return timeFormatter.format(date);
        }

        function isCancelled(details) {
          return /abgesagt/i.test(String(details || ""));
        }

        function cleanCancelledDetails(details) {
          var cleaned = String(details || "")
            .replace(/abgesagt/gi, "")
            .replace(/[-–—]/g, " ")
            .replace(/\s+/g, " ")
            .trim();
          if (!cleaned) {
            return "Clubabend";
          }
          return cleaned;
        }

        function formatLocation(location) {
          if (!location) {
            return "";
          }
          return String(location)
            .split(",")
            .map(function (part) {
              return escapeHtml(part.trim());
            })
            .filter(function (part) {
              return part.length > 0;
            })
            .join("<br />");
        }

        function renderRows(events) {
          return events
            .slice()
            .sort(function (a, b) {
              var aStart = toUtcDate(a.date, a.time);
              var bStart = toUtcDate(b.date, b.time);
              if (!aStart || !bStart) {
                return 0;
              }
              return aStart.getTime() - bStart.getTime();
            })
            .map(function (event) {
              var startLocal = toUtcDate(event.date, event.time);
              var endLocal = toUtcDate(event.end_date, event.end_time);
              var cancelled = isCancelled(event.details);
              var detailsText = cancelled
                ? cleanCancelledDetails(event.details)
                : String(event.details || "");
              var detailsHtml = cancelled
                ? '<span class="badge cancelled">Abgesagt</span> ' + escapeHtml(detailsText)
                : escapeHtml(detailsText);

              if (!startLocal || !endLocal) {
                return "";
              }

              return (
                '<tr' +
                (cancelled ? ' class="is-cancelled"' : "") +
                ">" +
                '<td data-label="Datum & Zeit">' +
                escapeHtml(formatDateDe(startLocal) + " | " + formatTime(startLocal) + "-" + formatTime(endLocal)) +
                "</td>" +
                '<td data-label="Details">' +
                detailsHtml +
                "</td>" +
                '<td data-label="Ort">' +
                formatLocation(event.location) +
                "</td>" +
                '<td data-label="Caller">' +
                escapeHtml(event.caller || "") +
                "</td>" +
                "</tr>"
              );
            })
            .filter(function (row) {
              return row.length > 0;
            });
        }

        function renderSchedule(events) {
          var rows = renderRows(events);

          if (!rows.length) {
            contentEl.innerHTML = "<p>Keine Termine vorhanden.</p>";
            statusEl.textContent = "";
            return;
          }

          contentEl.innerHTML =
            "<table>" +
            "<thead>" +
            "<tr>" +
            "<th>Datum & Zeit</th>" +
            "<th>Details</th>" +
            "<th>Ort</th>" +
            "<th>Caller</th>" +
            "</tr>" +
            "</thead>" +
            "<tbody>" +
            rows.join("") +
            "</tbody>" +
            "</table>";
          statusEl.textContent = "";
        }

        fetch("events.json", { cache: "no-store" })
          .then(function (response) {
            if (!response.ok) {
              throw new Error("HTTP " + response.status);
            }
            return response.json();
          })
          .then(function (events) {
            if (!Array.isArray(events)) {
              throw new Error("events.json hat kein Array-Format");
            }
            renderSchedule(events);
          })
          .catch(function () {
            statusEl.textContent = "Events konnten nicht geladen werden.";
            contentEl.innerHTML = "";
          });
      })();
    </script>
    {{ include: footer.html }}
  </body>
</html>
